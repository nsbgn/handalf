#!/bin/bash

# XF86RotateWindows XF86ApplicationLeft XF86ApplicationRight XF86AudioPause XF86Terminal 

if [ -z "${DISPLAY}" ]; then
    echo "\$DISPLAY not set" >&2
    exit 1
fi

XKBDIR=/tmp/xkb
mkdir -p ${XKBDIR}/{keymap,symbols,types,compat}

# Generate a basic keymap.
setxkbmap -option -print \
    | sed 's/\(\s*xkb_symbols\s*{\s*include\s*".*\)\("\s*};\s*\)/\1+thumbledore\2/g' \
    | sed 's/\(\s*xkb_compat\s*{\s*include\s*".*\)\("\s*};\s*\)/\1+thumbledore\2/g' \
    | sed 's/\(\s*xkb_types\s*{\s*include\s*".*\)\("\s*};\s*\)/\1+thumbledore\2/g' \
    > ${XKBDIR}/keymap/thumbledore.xkb

tee > ${XKBDIR}/compat/thumbledore << EOF
default xkb_compatibility "td" {
    interpret BackSpace+AnyOfOrNone(all) {
        repeat= True;
        action= Redirect(key=<BKSP>);
    };
    interpret Return+AnyOfOrNone(all) {
        repeat= True;
        action= Redirect(key=<RTRN>);
    };
};
EOF

# Generate type map
tee > ${XKBDIR}/types/thumbledore << EOF
default xkb_types "td" {
    virtual_modifiers Symbol;

    type "NONE_SHIFT_SYM_SUPER" {
        modifiers = Shift+LevelThree+Mod4;
        map[None] = Level1;
        map[Shift] = Level2;
        map[Mod4] = Level3;
        level_name[Level1] = "Base";
        level_name[Level2] = "Shift";
        level_name[Level3] = "Super";
    };

    type "NONE_SUPER" {
        modifiers = Mod4;
        map[None] = Level1;
        map[Mod4] = Level2;
        level_name[Level1] = "Base";
        level_name[Level2] = "Super";
    };

    type "NONE_SYM" {
        modifiers = LevelThree;
        map[None] = Level1;
        map[LevelThree] = Level2;
        level_name[Level1] = "Base";
        level_name[Level2] = "Symbol";
    };

};
EOF

tee > ${XKBDIR}/symbols/thumbledore << EOF
default partial modifier_keys
partial
xkb_symbols "td" {


    key <I253> { [ Multi_key ] };
    key <I254> { [ dead_greek ] };
    key <I255> { [ Escape ], [at] };

    # Modifier keys themselves

    modifier_map Mod1 { Alt_L };
    modifier_map Mod4 { Super_L };

    replace key <LWIN> { [ Alt_L ] };

    replace key <LALT> {
        [ Super_L ], [at]
    , actions[Group1] = [SetMods(mods=Mod4)]
    , actions[Group2] = [Redirect(key=<AE02>, modifiers=Shift)]
    };

    key.type[Group1] = "NONE_SUPER";

    replace key <RALT> {
        [ ISO_Level3_Shift, Super_L ]
    , actions[Group1] = [ SetGroup(group=2), SetMods(mods=Mod4+Shift) ]
    };


    key.type[Group1] = "NONE_SHIFT_SYM_SUPER";

    # Row 1

    key <AD01> {
        [ q, Q, Home ], [asciicircum]
    , actions[Group1] =
        [ NoAction(), NoAction(), Redirect(key=<HOME>, clearMods=all) ] };
    key <AD02> {
        [ w, W, Up ], [numbersign]
    , actions[Group1] =
        [ NoAction(), NoAction(), Redirect(key=<UP>, clearMods=all) ] };
    key <AD03> {
        [ e, E, End ], [bracketleft]
    , actions[Group1] =
        [ NoAction(), NoAction(), Redirect(key=<END>, clearMods=all) ] };
    key <AD04> {
        [ r, R, Prior ], [bracketright]
    , actions[Group1] =
        [ NoAction(), NoAction(), Redirect(key=<PGUP>, clearMods=all) ] };
    key <AD05> {
        [ t, T, t ], [equal] };
    key <AD06> {
        [ y, Y, y ], [plus] };
    key <AD07> {
        [ u, U, u ], [7]
    };
    key <AD08> {
        [ i, I, i ], [8] };
    key <AD09> {
        [ o, O, o ], [9] };
    key <AD10> {
        [ p, P, p], [dollar] };


    # Row 2

    replace key <CAPS> { [ BackSpace ] };

    key <AC01> {
        [ a, A, Left ], [less]
    , actions[Group1] =
        [ NoAction(), NoAction(), Redirect(key=<LEFT>, clearMods=all)] };
    key <AC02> {
        [ s, S, Down ], [greater]
    , actions[Group1] =
        [ NoAction(), NoAction(), Redirect(key=<DOWN>, clearMods=all) ] };
    key <AC03> {
        [ d, D, Right ], [parenleft]
    , actions[Group1] =
        [ NoAction(), NoAction(), Redirect(key=<RGHT>, clearMods=all) ] };
    key <AC04> {
        [ f, F, Next ], [parenright]
    , actions[Group1] =
        [ NoAction(), NoAction(), Redirect(key=<PGDN>, clearMods=all) ] };
    key <AC05> {
        [ g, G, g ], [minus] };
    key <AC06> {
        [ h, H, h ], [asciitilde, h] };
    key <AC07> {
        [ j, J, j ], [4, j] };
    key <AC08> {
        [ k, K, k ], [5, k] };
    key <AC09> {
        [ l, L, l ], [6, l] };
    key <AC10> {
        [ semicolon, colon, semicolon ], [asterisk, semicolon] };
    key <AC11> {
        [ apostrophe, quotedbl, apostrophe ], [grave, apostrophe] };

    # Row 3

    key <AB01> { [ z, Z, z ], [bar] };
    key <AB02> { [ x, X, x ], [ampersand] };
    key <AB03> { [ c, C, c ], [braceleft] };
    key <AB04> { [ v, V, v ], [braceright] };
    key <AB05> { [ b, B, b ], [underscore] };
    key <AB06> { [ n, N, n ], [0] };
    key <AB07> { [ m, M, m ], [1] };
    key <AB08> { [ comma, question, comma ], [2] };
    key <AB09> { [ period, exclam, period ], [3] };
    key <AB10> { [ slash, backslash, slash], [percent] };


};
EOF

# Compile the new xkbmap
xkbcomp -synch -w3 -I${XKBDIR} ${XKBDIR}/keymap/thumbledore.xkb ${DISPLAY}

# (Re)start xcape, to make sure we can still use the original keys by tapping
# the respective modifiers.
pkill xcape
TAP=$(tr -d '[:space:]' << EOF
    Super_L=Escape;
    ISO_Level3_Shift=Return;
    Control_L=Multi_key;
    Control_R=dead_greek
EOF
)
xcape -t 150ms -e "${TAP}"
