#!/bin/bash

if [ -z "${DISPLAY}" ]; then
    echo "\$DISPLAY not set" >&2
    exit 1
fi

XKBDIR=/tmp/xkb
mkdir -p ${XKBDIR}/{keymap,symbols,types,compat}

# Generate a basic keymap.
setxkbmap -option -option caps:super -print \
    | sed 's/\(\s*xkb_symbols\s*{\s*include\s*".*\)\("\s*};\s*\)/\1+custom(special)\2/g' \
    | sed 's/\(\s*xkb_types\s*{\s*include\s*".*\)\("\s*};\s*\)/\1+custom(special)\2/g' \
    | sed 's/\(\s*xkb_compat\s*{\s*include\s*".*\)\("\s*};\s*\)/\1+custom(special)\2/g' \
    > ${XKBDIR}/keymap/custom.xkb

# Generate compatibility map
tee > ${XKBDIR}/compat/custom << EOF
xkb_compatibility "special" {

   interpret Alt_L { action= SetMods(modifiers=Mod1); };
   interpret Alt_R { action= SetMods(modifiers=Mod1); };

   interpret Super_L { action= SetMods(modifiers=Mod4); };

   interpret Hyper_L { action= SetMods(modifiers=Mod3); };
   interpret Hyper_R { action= SetMods(modifiers=Mod5); };
};
EOF

# Generate type map
tee > ${XKBDIR}/types/custom << EOF
default xkb_types "special" {

    type "NONE_SHIFT_LALT_RALT" {

        modifiers = Shift+Mod3+Mod5;
        map[None] = Level1;
        map[Shift] = Level2;
        map[Mod3] = Level3;
        map[Mod3+Shift] = Level3;
        map[Mod5] = Level4;
        map[Mod5+Shift] = Level4;
        map[Mod5+Mod3] = Level4;
        map[Mod5+Mod3+Shift] = Level4;

        preserve[Mod3] = Mod3;
        preserve[Mod3+Shift] = Mod3+Shift;
        preserve[Mod5+Shift] = Shift;
        preserve[Mod5+Mod3] = Mod3;
        preserve[Mod5+Mod3+Shift] = Mod3+Shift;

        level_name[Level1] = "Base";
        level_name[Level2] = "Shift";
        level_name[Level3] = "Alt_L";
        level_name[Level4] = "Alt_R";
    };
};
EOF


# Add customisations to its `xkb_symbols`. We assign Tab to some weird key so
# that `xcape` won't get confused. We use the ISO_Level3_Shift key for mode
# switching, because we can then just add our special keys as level 3 syms.
# Check out /usr/share/X11/xkb for codes and /usr/include/X11/keysymdef.h (from
# x11proto-dev) for symbols. Use `xev` for inspection. Use `xmodmap` to see
# which modifiers are bound to which keys.
# https://bbs.archlinux.org/viewtopic.php?id=248080
tee > ${XKBDIR}/symbols/custom << EOF
default partial modifier_keys
partial
xkb_symbols "special" {

    # Modifier keys themselves
    key <LWIN> { [ Alt_L, Super_L ] };
    key <LALT> { [ Hyper_L ] };
    key <RALT> { [ Hyper_R ] };

    modifier_map Shift { Shift_L };
    #modifier_map Lock {};
    modifier_map Control { Control_L, Control_R };
    modifier_map Mod1 { Alt_L, Alt_R };
    #modifier_map Mod3 {};
    modifier_map Mod4 { Super_L };
    #modifier_map Mod5 { 0x42 };

    key.type[Group1] = "NONE_SHIFT_LALT_RALT";

    # Perhaps turn plain Return into menu key?
    key <RTRN> { [ Return, Return, equal, equal  ] };

    # Perhaps use tab key?
    key <RTSH> { [ Multi_key, dead_greek, dead_greek, dead_greek ] };

    key <AD01> { [ q, Q, Home, Home ] };
    key <AD02> { [ w, W, Up, Up ] };
    key <AD03> { [ e, E, End, End ] };
    key <AD04> { [ r, R, Prior, Prior ] };
    key <AD05> { [ t, T, numbersign, numbersign ] };
    key <AD06> { [ y, Y, at, at ] };
    key <AD07> { [ u, U, 7, 7 ] };
    key <AD08> { [ i, I, 8, 8 ] };
    key <AD09> { [ o, O, 9, 9 ] };
    key <AD10> { [ p, P, plus, plus ] };
    key <AD11> { [ braceleft, VoidSymbol, asciicircum, asciicircum ] };
    key <AD12> { [ braceright, ampersand, dollar, dollar ] };

    key <AC01> { [ a, A, Left, Left ] };
    key <AC02> { [ s, S, Down, Down ] };
    key <AC03> { [ d, D, Right, Right ] };
    key <AC04> { [ f, F, Prior, Prior ] };
    key <AC05> { [ g, G, asciitilde, asciitilde ] };
    key <AC06> { [ h, H, asterisk, asterisk ] };
    key <AC07> { [ j, J, 4, 4 ] };
    key <AC08> { [ k, K, 5, 5 ] };
    key <AC09> { [ l, L, 6, 6 ] };
    key <AC10> { [ semicolon, colon, minus, minus ] };
    key <AC11> { [ apostrophe, quotedbl, grave, grave ] };

    key <AB01> { [ z, Z, bracketleft, bracketleft ] };
    key <AB02> { [ x, X, bracketright, bracketright ] };
    key <AB03> { [ c, C, parenleft, parenleft ] };
    key <AB04> { [ v, V, parenright, parenright ] };
    key <AB05> { [ b, B, underscore, underscore ] };
    key <AB06> { [ n, N, 0, 0 ] };
    key <AB07> { [ m, M, 1, 1 ] };
    key <AB08> { [ comma, less, 2, 2 ] };
    key <AB09> { [ period, greater, 3, 3 ] };
    key <AB10> { [ slash, question, exclam, exclam ] };

    # Thumb cluster
    key <SPCE> { [ space, space, BackSpace, Delete ] };
};
EOF

# Compile the new xkbmap
xkbcomp -synch -w3 -I${XKBDIR} ${XKBDIR}/keymap/custom.xkb ${DISPLAY}

# (Re)start xcape, to make sure we can still use the original keys by tapping
# the respective modifiers.
pkill xcape
xcape -e 'Super_L=Escape;Hyper_L=Tab;Hyper_R=Return' -t 150ms
